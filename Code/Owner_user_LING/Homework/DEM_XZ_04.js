/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var image2 = ee.Image("projects/ee-glj320104/assets/Home_work/xzDSM"),
    image3 = ee.Image("projects/ee-glj320104/assets/Home_work/xzRGB"),
    image = ee.Image("projects/ee-glj320104/assets/Home_work/xzDEM_F"),
    table = ee.FeatureCollection("projects/ee-glj320104/assets/Home_work/njxz_roi"),
    Background = 
    /* color: #000000 */
    /* shown: false */
    ee.Feature(
        ee.Geometry.MultiPolygon(
            [[[[118.89287882307342, 31.893880555586748],
               [118.89481001356414, 31.893170044329594],
               [118.89486365774444, 31.893989864524272],
               [118.89321141699126, 31.89449086216081]]],
             [[[118.89394618984802, 31.89208396279379],
               [118.89329173084839, 31.891455421620492],
               [118.89416076656921, 31.891400765663544],
               [118.89446117397888, 31.891956433047607]]],
             [[[118.8950101880933, 31.894568602841698],
               [118.89469905184757, 31.89424978674853],
               [118.89509601878177, 31.893994733079094],
               [118.89602942751895, 31.89407671469276],
               [118.8957504777814, 31.894322659095728]]]]),
        {
          "system:index": "0",
          "class": 0
        }),
    Building = 
    /* color: #00fff6 */
    /* shown: false */
    ee.Feature(
        ee.Geometry.MultiPolygon(
            [[[[118.89274949921668, 31.893044637013936],
               [118.89285678757727, 31.89300364575674],
               [118.89285142315924, 31.892978595535045],
               [118.89344150914252, 31.892728092943134],
               [118.89353270424903, 31.89290116753396],
               [118.89281923665106, 31.893172165252896]]],
             [[[118.89389480246604, 31.892987704707366],
               [118.89443392647803, 31.89275542053172],
               [118.89453316821158, 31.892926217776722],
               [118.89398867978156, 31.893153946943873]]],
             [[[118.89346833123267, 31.89272126104471],
               [118.89368559016287, 31.89262105980968],
               [118.8942300785929, 31.892400161247302],
               [118.89431859149039, 31.89255957263421],
               [118.89376873864234, 31.892796411899425],
               [118.893707047835, 31.892734924841054],
               [118.89352197541297, 31.892814630279204]]],
             [[[118.8930606354624, 31.89333840715636],
               [118.89385456933081, 31.89298542741436],
               [118.8939243067652, 31.893117510314973],
               [118.89371509446204, 31.89320176999739],
               [118.89373386992514, 31.89325187031256],
               [118.89315451277793, 31.89351148059997],
               [118.89311159743369, 31.893488707797026],
               [118.8930418599993, 31.893520589719547],
               [118.89295871151984, 31.893427221200955],
               [118.8930606354624, 31.89336117999648]]],
             [[[118.89518226279318, 31.8920650546934],
               [118.89560068739951, 31.8920627773776],
               [118.89560068739951, 31.892577449319695],
               [118.89516885174811, 31.892577449319695]]],
             [[[118.89561946286261, 31.892178920412334],
               [118.89564360274375, 31.892096937108906],
               [118.89619077338278, 31.892110600997864],
               [118.89620150221884, 31.8920650546934],
               [118.89674330843985, 31.8920650546934],
               [118.89673794402182, 31.892247239776093],
               [118.89618272675574, 31.892238130530522],
               [118.89617736233771, 31.892190306976488],
               [118.89565701378882, 31.892185752350986]]],
             [[[118.89555777205527, 31.8932655137775],
               [118.89557386530936, 31.893033230302702],
               [118.89518226279318, 31.89301728925844],
               [118.89517421616614, 31.892892038100307],
               [118.89562750948966, 31.89288520621407],
               [118.89562482728064, 31.89307422154672],
               [118.8957964886576, 31.893081053418964],
               [118.8957964886576, 31.89305144863564],
               [118.89600033654273, 31.89305144863564],
               [118.89601106537879, 31.89307194425588],
               [118.8961585868746, 31.89307194425588],
               [118.89617736233771, 31.892971743402487],
               [118.89677817715705, 31.89296946610908],
               [118.89678354157508, 31.893094717161897],
               [118.8962846506983, 31.893085608000163],
               [118.89627660407126, 31.8931812541534],
               [118.8962470997721, 31.893185808729637],
               [118.89624441756308, 31.893274622921425]]],
             [[[118.89689202884396, 31.893910857781645],
               [118.89689471105298, 31.89380610329588],
               [118.89694835523328, 31.893812935113825],
               [118.89694835523328, 31.893687685038042],
               [118.8964306888934, 31.893687685038042],
               [118.89641727784833, 31.89366035772614],
               [118.89622952321729, 31.893642139513684],
               [118.89621879438123, 31.89337797502819],
               [118.896897393262, 31.893359756759857],
               [118.896897393262, 31.893188960319087],
               [118.89707710126599, 31.893186683031068],
               [118.89706905463895, 31.893498670964718],
               [118.896897393262, 31.893469066315685],
               [118.89634217599591, 31.893473620877703],
               [118.89633681157788, 31.893576098463353],
               [118.89689202884396, 31.89357837574175],
               [118.89708783010205, 31.89357837574175],
               [118.89707173684796, 31.893842539652272],
               [118.89707978347501, 31.89393363048019]]],
             [[[118.89479212195678, 31.89108424955758],
               [118.8949020925264, 31.89103414806298],
               [118.89483771951004, 31.89093622233572],
               [118.89526150853439, 31.89076086670347],
               [118.8952454152803, 31.89072215177862],
               [118.89531515271469, 31.890694823586568],
               [118.89533929259582, 31.89072215177862],
               [118.89536075026794, 31.89082007773353],
               [118.89543316991134, 31.89084512854246],
               [118.8957148018579, 31.891327924619873],
               [118.8957684460382, 31.89135297529066],
               [118.89566920430465, 31.891416740603713],
               [118.89571211964889, 31.891505556501905],
               [118.89526687295242, 31.89168774269161],
               [118.89521322877212, 31.891596649641805],
               [118.89510862262054, 31.891626254892877]]],
             [[[118.89687185907202, 31.899789885521823],
               [118.8975531401618, 31.899908295930658],
               [118.89755850457983, 31.899967501077967],
               [118.8977516236289, 31.900017597711326],
               [118.89777844571906, 31.89994472987199],
               [118.89825051450568, 31.90002670618721],
               [118.89828270101385, 31.8998900789546],
               [118.89848654889899, 31.899926512903132],
               [118.89843826913672, 31.900231646655847],
               [118.8977516236289, 31.90013145359484],
               [118.89775698804694, 31.90004947737293],
               [118.89754241132574, 31.900008489234583],
               [118.89752095365363, 31.900085911258333],
               [118.89687722349005, 31.899981163798873]]],
             [[[118.89686113023596, 31.899685137725477],
               [118.89686649465399, 31.899393664969246],
               [118.89753704690771, 31.89938000216114],
               [118.8975531401618, 31.899439207648232],
               [118.89775698804694, 31.899439207648232],
               [118.89779990339117, 31.899389110700096],
               [118.89848654889899, 31.89939821923814],
               [118.8984704556449, 31.899562172768977],
               [118.89779990339117, 31.899566727029573],
               [118.89777308130103, 31.89948930456912],
               [118.89756386899786, 31.899502967360988],
               [118.89755850457983, 31.89957583555003],
               [118.89709180021124, 31.899562172768977],
               [118.89709180021124, 31.899703354742094]]],
             [[[118.89555754425449, 31.89841410843319],
               [118.8955790019266, 31.89808164265608],
               [118.89573457004947, 31.89808164265608],
               [118.89569701912326, 31.897945012536542],
               [118.89571311237735, 31.897607990708003],
               [118.89578821422977, 31.897535120961226],
               [118.89564337494296, 31.897516903515537],
               [118.895648739361, 31.8974576967921],
               [118.89643730881137, 31.8974576967921],
               [118.89643730881137, 31.897612545065265],
               [118.89649095299167, 31.897958675557618],
               [118.89650704624576, 31.89809985999002],
               [118.8962978339426, 31.898104414322955],
               [118.89594914677066, 31.898122631652388],
               [118.8959384179346, 31.89840044547969]]],
             [[[118.89394285442752, 31.897453142427178],
               [118.8939213967554, 31.89739849003057],
               [118.89398576977176, 31.89736660945088],
               [118.8939750409357, 31.897220869517543],
               [118.89394285442752, 31.89718898887636],
               [118.89392676117343, 31.897129781942013],
               [118.89400722744388, 31.897125227560885],
               [118.89401259186191, 31.896993150409745],
               [118.89451684715671, 31.89698859602185],
               [118.8945329404108, 31.897161662603704],
               [118.89406087162418, 31.897166216983027],
               [118.89406087162418, 31.897439479331066],
               [118.89457585575504, 31.89743037059919],
               [118.89460804226321, 31.897530566600146],
               [118.89399649860782, 31.897535120961226]]],
             [[[118.89477433922214, 31.897617099422302],
               [118.89476361038608, 31.89741670749969],
               [118.8947314238779, 31.897289185140032],
               [118.89475288155002, 31.89717532574104],
               [118.89476361038608, 31.897061466201237],
               [118.89476361038608, 31.8970113679591],
               [118.8950747466318, 31.896956715300234],
               [118.89508011104984, 31.897630762492053]]],
             [[[118.89421107532901, 31.898341239324505],
               [118.89505328895969, 31.898391336842902],
               [118.89508011104984, 31.898992504937265],
               [118.89423253300113, 31.899010722090974]]],
             [[[118.89449280984729, 31.899388104622336],
               [118.89614505060047, 31.899374441813418],
               [118.89611822851032, 31.8995475039099],
               [118.89520091302722, 31.899511069811346],
               [118.89522773511737, 31.899902735614866],
               [118.89446598775714, 31.899911844102096]]],
             [[[118.89795351347036, 31.89712237274029],
               [118.8984470399291, 31.897104155212926],
               [118.89846849760121, 31.897208905946147],
               [118.89795351347036, 31.89721346032315]]],
             [[[118.8990961345107, 31.89705405699402],
               [118.89914441427297, 31.89689920778144],
               [118.89923024496144, 31.896771684704905],
               [118.89953601678914, 31.89672158630509],
               [118.89973450025624, 31.896803565490593],
               [118.90003490766591, 31.896799011093307],
               [118.90001344999379, 31.89692653413198],
               [118.89988470396108, 31.896949306084593],
               [118.89984178861684, 31.8972271234528],
               [118.89960575422353, 31.89735464589844],
               [118.89934289774007, 31.897359200268244],
               [118.89915514310903, 31.897249895331065]]],
             [[[118.90027630647725, 31.897208905946147],
               [118.90034604391164, 31.89716791654298],
               [118.9006089003951, 31.8972271234528],
               [118.90056062063283, 31.89735464589844],
               [118.90027630647725, 31.89728633032453]]],
             [[[118.90042114576406, 31.897063165763118],
               [118.90050697645253, 31.89681267428448],
               [118.90057671388692, 31.89681722868108],
               [118.90063035806722, 31.896803565490593],
               [118.90072691759175, 31.896826337473613],
               [118.90064645132131, 31.897035839453114],
               [118.90095758756704, 31.897090492065008],
               [118.90087712129659, 31.89725900408078],
               [118.90067327341146, 31.8971952428138],
               [118.90067327341146, 31.89712237274029]]],
             [[[118.9003727258483, 31.90023331963733],
               [118.90035663259421, 31.898826052587612],
               [118.90061948907767, 31.898862486957277],
               [118.90074823511038, 31.89936345807781],
               [118.9007321418563, 31.899823438251186],
               [118.90063558233176, 31.900228765409732]]],
             [[[118.90014205587302, 31.898301462596947],
               [118.90061948907767, 31.898278690978795],
               [118.90064631116782, 31.89848363533919],
               [118.90013132703696, 31.898501852593586]]],
             [[[118.90013669145499, 31.898265028005227],
               [118.90014205587302, 31.89772761610247],
               [118.90065167558585, 31.897718507399112],
               [118.90070531976615, 31.89790523563777],
               [118.9002117933074, 31.89790523563777],
               [118.90020642888938, 31.897982659430518],
               [118.9002815307418, 31.897996322445994],
               [118.90026007306967, 31.89821493041808],
               [118.90019033563529, 31.89821493041808],
               [118.90017960679923, 31.898283245302878]]],
             [[[118.89623315453532, 31.896285316604594],
               [118.89627606987956, 31.896226109089067],
               [118.89622242569926, 31.89619422810339],
               [118.89625461220744, 31.896125911668367],
               [118.89636190056804, 31.896153238248463],
               [118.89639945149425, 31.89611224837529],
               [118.89668376564983, 31.896253435639423],
               [118.89675350308421, 31.896212445810853],
               [118.89711828351024, 31.896390068269515],
               [118.89710755467418, 31.89647660216369],
               [118.8969841730595, 31.89648571098994],
               [118.89672668099406, 31.89634452408203],
               [118.89661939263347, 31.89643561243448],
               [118.89693589329723, 31.896617788869065],
               [118.89694125771526, 31.896672441729145],
               [118.89683933377269, 31.896704322549205],
               [118.89649064660075, 31.896508483051583],
               [118.89651210427287, 31.896426503603294]]],
             [[[118.89381187833379, 31.895190071006535],
               [118.89394062436651, 31.895158189662116],
               [118.89401572621892, 31.895203734436503],
               [118.89393525994848, 31.895299378389357],
               [118.8937957850797, 31.89537680437366],
               [118.89373677648138, 31.895285714973614]]],
             [[[118.8936509457929, 31.89498056482674],
               [118.89434295571874, 31.894711849680835],
               [118.8944073287351, 31.894775612667782],
               [118.89367776788305, 31.895085317976214]]],
             [[[118.89352219976018, 31.894821157631423],
               [118.89423566735815, 31.89452056045502],
               [118.89425712503026, 31.89456610554484],
               [118.89353829301427, 31.894866702572525]]],
             [[[118.89715675502322, 31.892343471289557],
               [118.8980365195801, 31.892343471289557],
               [118.89805261283419, 31.89243000898712],
               [118.89717821269534, 31.892439118213712]]],
             [[[118.89882384414645, 31.89339252007499],
               [118.89896331901522, 31.893219446407777],
               [118.89923153991671, 31.893192118956893],
               [118.89936565036746, 31.893679457280147],
               [118.89927981967898, 31.89378876645642],
               [118.89899014110537, 31.89378876645642],
               [118.89882920856448, 31.8936202480888]]],
             [[[118.8968679456556, 31.891179854903765],
               [118.89761896417977, 31.89118896425402],
               [118.89763505743386, 31.891375705735914],
               [118.89687867449166, 31.891384815066807]]],
             [[[118.89683039472939, 31.89174463291626],
               [118.89682503031136, 31.891603438737878],
               [118.89766187952401, 31.891626212007118],
               [118.8976243285978, 31.891776515442675],
               [118.89699132727029, 31.891781070088427]]],
             [[[118.90077904394356, 31.89554725898827],
               [118.90119210413185, 31.895551813447486],
               [118.901218926222, 31.895638348129577],
               [118.90078440836159, 31.895642902584267]]],
             [[[118.90077367952553, 31.895219710521566],
               [118.90110627344338, 31.895242482896357],
               [118.90110090902535, 31.89529713657287],
               [118.90074149301735, 31.8952834731568]]],
             [[[118.89971152475563, 31.895524859875795],
               [118.90015140703407, 31.895543077715693],
               [118.90017822912422, 31.895625057950653],
               [118.8996525161573, 31.895625057950653]]],
             [[[118.89846161535469, 31.896171590984718],
               [118.89891222646919, 31.896203471978232],
               [118.89892831972328, 31.89626723393211],
               [118.8984079711744, 31.896262679508283]]],
             [[[118.89633788284779, 31.895051890612482],
               [118.89641834911824, 31.894956246402515],
               [118.89667584118367, 31.8948697110793],
               [118.89677776512623, 31.894983573329796],
               [118.89708890137196, 31.89485604759979],
               [118.89714790997029, 31.89494258293583],
               [118.89679385838032, 31.895111098883145],
               [118.8967187565279, 31.895051890612482],
               [118.89644517120838, 31.89518397054864]]]]),
        {
          "class": 1,
          "system:index": "0"
        }),
    Water = 
    /* color: #0b4a8b */
    /* shown: false */
    ee.Feature(
        ee.Geometry.MultiPolygon(
            [[[[118.89811466347358, 31.895246475111875],
               [118.89782498489997, 31.894781917571706],
               [118.89830778252265, 31.894663500568896],
               [118.89855454575202, 31.89505518699686]]],
             [[[118.89990920715528, 31.892914059461102],
               [118.89969463043408, 31.892804749246366],
               [118.89978046112256, 31.892540582358357],
               [118.9001130550404, 31.8929413869945]]],
             [[[118.892623044653, 31.892381353729615],
               [118.89253721396453, 31.89199876519684],
               [118.8932882324887, 31.891862126049897],
               [118.89337406317718, 31.892244715150387]]],
             [[[118.89894839990475, 31.899881449064665],
               [118.8987767385278, 31.89951710875217],
               [118.89887329805234, 31.89955354284831]]],
             [[[118.89804717767575, 31.895791646301152],
               [118.89804717767575, 31.895381745138145],
               [118.89833685624936, 31.895472834443186]]],
             [[[118.89744636285641, 31.897312819107896],
               [118.89718887079098, 31.89719440536042],
               [118.89751073587277, 31.897094208993597]]],
             [[[118.89940973985532, 31.891877582862822],
               [118.8987230943475, 31.89083000950912],
               [118.89875528085568, 31.890693368627833]]],
             [[[118.89730955995377, 31.898791195133906],
               [118.89692332185562, 31.89869555480871],
               [118.89693941510971, 31.898399524600975],
               [118.89712985194977, 31.898492888076966],
               [118.89737661517914, 31.898681891897024]]]]),
        {
          "class": 2,
          "system:index": "0"
        }),
    Road = 
    /* color: #ffc82d */
    /* shown: false */
    ee.Feature(
        ee.Geometry.MultiPolygon(
            [[[[118.89452877528048, 31.89180201686865],
               [118.89418545252657, 31.891278231251686],
               [118.89426860100603, 31.89118713779678],
               [118.8943893004117, 31.891326055279468],
               [118.89463338143206, 31.891783798288515]]],
             [[[118.89525830746682, 31.892721056223678],
               [118.89526367188485, 31.892629964196136],
               [118.8955077529052, 31.892636796101353],
               [118.89552921057732, 31.892757493009473]]],
             [[[118.89588698533291, 31.89381181735913],
               [118.89581993010754, 31.893793599176668],
               [118.89592721846813, 31.89375716280091],
               [118.89596745160335, 31.893647853587108],
               [118.89599963811153, 31.893675180902726],
               [118.89601036694759, 31.8937321127842]]],
             [[[118.89545910274015, 31.89491296736887],
               [118.89563344632612, 31.89496078950875],
               [118.8958292475842, 31.89506326543914],
               [118.89590434943662, 31.89513613714247],
               [118.89588020955549, 31.895170295733557],
               [118.89577292119489, 31.895051879230298],
               [118.89554761563764, 31.89496306675288],
               [118.89537327205167, 31.894924353594917]]],
             [[[118.89443718110547, 31.89586712822525],
               [118.89438085471616, 31.895691781983754],
               [118.89434598599897, 31.895648514677987],
               [118.89441304122434, 31.895561980005464],
               [118.89445595656858, 31.89555287108782],
               [118.89444522773252, 31.895671286946726],
               [118.8944774142407, 31.89580336599426],
               [118.89450960074888, 31.89591722709004]]],
             [[[118.89525793706403, 31.896445540731968],
               [118.89523111497388, 31.896338511920074],
               [118.89537595426069, 31.896331680289578],
               [118.89547251378522, 31.89629069049584],
               [118.89560662423597, 31.896267918380303],
               [118.89560662423597, 31.896295244918267],
               [118.89544032727704, 31.896347620759986],
               [118.89539472972379, 31.896404550988915]]],
             [[[118.89581851874814, 31.897280221165758],
               [118.89581583653913, 31.897195965215833],
               [118.89602504884229, 31.89720507397089],
               [118.8962423077725, 31.897275666792055]]],
             [[[118.89578365003095, 31.89741457508851],
               [118.89578096782193, 31.897339428003338],
               [118.89625035439954, 31.89733259644709],
               [118.89627449428068, 31.89740546635417]]],
             [[[118.89652693141355, 31.897835853066482],
               [118.89650547374143, 31.897653679042325],
               [118.89658594001187, 31.89764684750941]]],
             [[[118.89720362079412, 31.89540357883102],
               [118.89709901464254, 31.895171300750313],
               [118.89721166742116, 31.89514397387875],
               [118.89728408706456, 31.89544456901973]]],
             [[[118.8979459741366, 31.89325226617188],
               [118.8979459741366, 31.892748984496812],
               [118.89798352506281, 31.892758093691857],
               [118.8979808428538, 31.893270484461457]]]]),
        {
          "class": 3,
          "system:index": "0"
        }),
    Playground = 
    /* color: #ff0000 */
    /* shown: false */
    ee.Feature(
        ee.Geometry.MultiPolygon(
            [[[[118.89602014013997, 31.889859820413424],
               [118.89619180151692, 31.889852988302177],
               [118.89621325918904, 31.88955237490619],
               [118.89655121752492, 31.88955237490619],
               [118.89653780647984, 31.89019231588073],
               [118.89654585310689, 31.891041768027083],
               [118.89598258921376, 31.891039490685962]]],
             [[[118.89680602738133, 31.89045648950571],
               [118.8968006629633, 31.890019236198217],
               [118.89684357830754, 31.889693572229554],
               [118.89739074894658, 31.889750506572906],
               [118.89766165205708, 31.889515936852117],
               [118.89766969868413, 31.889764170810047],
               [118.89768579193822, 31.890609072202476],
               [118.8975034017252, 31.89077304138579],
               [118.89724054524174, 31.890889186047318],
               [118.89705815502873, 31.890857303213657],
               [118.89681139179936, 31.890747990557248]]],
             [[[118.89967165501088, 31.900323405836136],
               [118.89938197643727, 31.900084308816698],
               [118.89934174330205, 31.89972452355989],
               [118.89934710772008, 31.899137023092297],
               [118.89952413351506, 31.898893368697607],
               [118.89966629059285, 31.899061877413185],
               [118.90000156671971, 31.899007225971662],
               [118.90014104158848, 31.898925248748533],
               [118.90024296553105, 31.89921672298797],
               [118.90024296553105, 31.900087249847978],
               [118.90002570660084, 31.900219322559845],
               [118.8999452403304, 31.900308129966465]]]]),
        {
          "class": 4,
          "system:index": "0"
        });
/***** End of imports. If edited, may not auto-convert in the playground. *****/
var roi = table;
var dem_xz = image.clip(roi);
var viz = {min:0,max:16};
var viz = {min:0,max:75};
var rgb_xz = image3.clip(roi).select("b1","b2","b3");
var dsm_xz = image2.clip(roi);


Map.centerObject(roi,15);
Map.addLayer(dem_xz,viz,"DEM");
Map.addLayer(rgb_xz,{},"RGB");
Map.addLayer(dsm_xz,viz,"DSM");


// 计算特征
var terrain = ee.Algorithms.Terrain(dsm_xz).select("slope","aspect","hillshade");
var GI = rgb_xz.select('b2').divide(rgb_xz.select('b2')).rename("GI");
var glcm_rgb = rgb_xz.glcmTexture();

// 波段融合
var sample_img = rgb_xz.addBands(dsm_xz.rename('dsm')).addBands(terrain).addBands(GI).addBands(glcm_rgb);
var band_list = sample_img.bandNames();
print("融合波段列表",band_list);


// ---------------------------------------------RF---------------------------------------------
// --------------------------------------准备样本数据-----------------------------------------
// 合并训练的数据（这里使用面，不是用点，为了更快的选取训练数据，点都是一个一个的选取，但是我画一个面就有很多个点数据）
// var polygon =ee.FeatureCollection([Water,Road,Grass,Bare_ground,Play_ground,Back_ground]);

var polygon =ee.FeatureCollection([Background,Building,Water,Road,Playground]);

// 通过选取的面，转为点数据，实际其实是根据选取的位置获取图像上的特征
var points = sample_img.sampleRegions({
  collection: polygon,
  properties: ['class'],
  scale: 5
});

print("样本点总量:",points.size());

// 以下就是纯粹为了选取XXX个点的数据进行训练模型，XXX个点数据进行验证模型
// 备注：有一个bug,如果点的数据少于输入的数据，那这个函数就没有意义了
var split = function(data,number){
  var tr = data.randomColumn('random', 555) ;
  var train = ee.FeatureCollection([]);
  var test = ee.FeatureCollection([]);
  for(var i = 0;i<=4;i++){
    var cate = tr.filter(ee.Filter.eq("class",i)).limit(number,"random");
    var cate_tr = cate.limit(number*0.7,"random",false);
    var cate_test = cate.limit(number*0.3,"random",true);
    train = train.merge(cate_tr);
    test = test.merge(cate_test);
  }
  return [train,test];
};

var train_test = split(points,5000);

var trainingPartition = train_test[0];
var testingPartition = train_test[1];

print("训练集数量:",trainingPartition.size());
print("测试集数量:",testingPartition.size());

// 统计每类有多少个数据
var figure_histogram = function(points){
                        var histogram = ui.Chart.feature.histogram({
                        features: points,
                        property: "class",
                        minBucketWidth:1, 
                        maxBuckets:3,
                        }).setOptions({
                            legend: {'position': 'none' },
                            title: 'counts of different categories',
                            hAxis: {'title': 'categories'},
                            vAxis: {'title': 'counts'},
                        });
                        print(histogram);
                        return histogram;
};

// 训练数据， 验证数据出图
figure_histogram(trainingPartition);
figure_histogram(testingPartition);

// -----------------------------------------使用RF进行分类-----------------------------------------

//分类方法选择随机森林

var inputbands = band_list;

var rf = ee.Classifier.smileRandomForest({
  numberOfTrees: 20,  
  bagFraction: 0.8
}).train({
  features: trainingPartition,
  classProperty: 'class',
  inputProperties: inputbands
});
//对哨兵数据进行随机森林分类
var img_classfication = sample_img.classify(rf); 
//运用测试样本分类，确定要进行函数运算的数据集以及函数
var test = testingPartition.classify(rf);
//计算混淆矩阵
var confusionMatrix = test.errorMatrix('class', 'classification');
print('confusionMatrix',confusionMatrix);//面板上显示混淆矩阵
print('overall accuracy', confusionMatrix.accuracy());//面板上显示总体精度
print('kappa accuracy', confusionMatrix.kappa());//面板上显示kappa值
// Map.addLayer(img_classfication.clip(roi), {min: 6, max: 7, palette: ['blue', 'silver', 'green','brown','red','black']},"classification");
Map.addLayer(img_classfication, {min: 0, max: 4, palette: ['black','cyan','blue','silver','red']},"classification");


// 去除非植被

var veg = img_classfication.updateMask(img_classfication.eq(0));
var veg_dem = dem_xz.updateMask(img_classfication.eq(0));
var veg_dsm = dsm_xz.updateMask(img_classfication.eq(0));
var veg_rgb = rgb_xz.updateMask(img_classfication.eq(0));

var temp = veg_dsm.subtract(veg_dem);

print(temp);
Map.addLayer(temp,{},"temp",0);

var veg_class = ee.Image(0).clip(roi).updateMask(img_classfication.eq(0));

veg_class = veg_class.where(temp.gt(3.3),2);
veg_class = veg_class.where(temp.lt(3.3).and(temp.gt(1)),1);
// veg_class = veg_class.where()
// veg_class = veg_class.where()
// veg_class = veg_class.where()

Map.addLayer(veg_class,{min:0,max:2,palette:['d9ff92','ffe4b1','00d530']},'veg_class');

// unmask插补非植被
var veg_class_all = veg_class.unmask(3).clip(roi);
Map.addLayer(veg_class_all,{min:0,max:3,palette:['d9ff92','ffe4b1','00d530','silver']},"veg_class_all");

print(veg_class_all.bandNames());

var veg_class_all = veg_class_all.rename('B1');

// export
Export.image.toDrive({
  image:veg_class_all, //分类结果
  description:'veg_class_all', //文件名
  scale:1, //分辨率
  region:roi, //区域
  maxPixels:1e13 //此处值设置大一些，防止溢出
});